-- 1. Get latest record per group
SELECT *
FROM (
    SELECT *, 
           ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY created_date DESC) rn
    FROM orders
) t
WHERE rn = 1;

-- 2. Find duplicate records
SELECT email, COUNT(*)
FROM users
GROUP BY email
HAVING COUNT(*) > 1;

-- 3. Second highest salary
SELECT MAX(salary) 
FROM employees
WHERE salary < (SELECT MAX(salary) FROM employees);

-- 4. Records not in another table
SELECT *
FROM customers c
WHERE NOT EXISTS (
    SELECT 1 FROM orders o WHERE o.customer_id = c.customer_id
);

-- 5. Top 10 percent records
SELECT *
FROM employees
WHERE salary >= (
    SELECT PERCENTILE_CONT(0.9) 
    WITHIN GROUP (ORDER BY salary) OVER ()
);

-- 6. Running total
SELECT order_date,
       SUM(amount) OVER (ORDER BY order_date) AS running_total
FROM orders;

-- 7. Fetch random rows
SELECT TOP 5 *
FROM products
ORDER BY NEWID();

-- 8. Conditional aggregation
SELECT
    SUM(CASE WHEN status = 'Completed' THEN amount END) AS completed_amount,
    SUM(CASE WHEN status = 'Pending' THEN amount END) AS pending_amount
FROM payments;
